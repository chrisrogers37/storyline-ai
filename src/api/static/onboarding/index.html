<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Storyline AI Setup</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/onboarding/style.css">
</head>
<body>
    <div id="app">
        <!-- Home Screen (returning users) -->
        <div class="step hidden" id="step-home">
            <div class="step-content">
                <h1>Storyline AI</h1>
                <p class="subtitle">Your posting dashboard</p>

                <!-- Instagram (expandable with account management) -->
                <div class="home-card home-card-expandable" id="home-card-instagram">
                    <div class="home-card-header" onclick="App.toggleCard('instagram')">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x1F4F8;</span>
                            <span>Instagram</span>
                        </div>
                        <div class="home-card-header-right">
                            <span class="home-card-badge" id="home-badge-instagram"></span>
                            <span class="home-card-chevron">&#x25B8;</span>
                        </div>
                    </div>
                    <div class="home-card-detail" id="home-detail-instagram"></div>
                    <div class="home-card-body" id="home-body-instagram">
                        <div class="card-body-loading hidden" id="instagram-account-loading">
                            <div class="spinner"></div>
                        </div>
                        <div id="instagram-account-list"></div>
                        <div class="confirm-dialog hidden" id="remove-account-confirm">
                            <p>Remove this account? It can be re-added later.</p>
                            <div class="confirm-actions">
                                <button class="btn btn-action-sm btn-action-danger" id="btn-confirm-remove" onclick="App.executeRemoveAccount()">Yes, Remove</button>
                                <button class="btn btn-action-sm" onclick="App.cancelRemoveAccount()">Cancel</button>
                            </div>
                        </div>
                        <div class="card-body-actions" id="instagram-account-actions">
                            <button class="btn btn-action-sm" onclick="App.connectOAuth('instagram')">Add Account</button>
                        </div>
                    </div>
                </div>

                <!-- Google Drive (static, not expandable) -->
                <div class="home-card" id="home-card-gdrive">
                    <div class="home-card-header">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x1F4C1;</span>
                            <span>Google Drive</span>
                        </div>
                        <span class="home-card-badge" id="home-badge-gdrive"></span>
                    </div>
                    <div class="home-card-detail" id="home-detail-gdrive"></div>
                    <button class="btn btn-card-edit" onclick="App.editSection('gdrive')">Edit</button>
                </div>

                <!-- Quick Controls (expandable) -->
                <div class="home-card home-card-expandable" id="home-card-controls">
                    <div class="home-card-header" onclick="App.toggleCard('controls')">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x2699;&#xFE0F;</span>
                            <span>Quick Controls</span>
                        </div>
                        <span class="home-card-chevron">&#x25B8;</span>
                    </div>
                    <div class="home-card-detail" id="home-detail-controls"></div>
                    <div class="home-card-body" id="home-body-controls">
                        <div class="toggle-row-compact">
                            <span>Delivery</span>
                            <label class="toggle toggle-sm">
                                <input type="checkbox" id="toggle-delivery" onchange="App.toggleSetting('is_paused')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-row-compact">
                            <span>Dry Run</span>
                            <label class="toggle toggle-sm">
                                <input type="checkbox" id="toggle-dryrun" onchange="App.toggleSetting('dry_run_mode')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-row-compact">
                            <span>Instagram API</span>
                            <label class="toggle toggle-sm">
                                <input type="checkbox" id="toggle-instagram-api" onchange="App.toggleSetting('enable_instagram_api')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-row-compact">
                            <span>Verbose Notifications</span>
                            <label class="toggle toggle-sm">
                                <input type="checkbox" id="toggle-verbose" onchange="App.toggleSetting('show_verbose_notifications')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="toggle-row-compact">
                            <span>Media Sync</span>
                            <label class="toggle toggle-sm">
                                <input type="checkbox" id="toggle-media-sync" onchange="App.toggleSetting('media_sync_enabled')">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div class="settings-divider"></div>
                        <div class="setting-row-numeric">
                            <span>Posts / Day</span>
                            <div class="stepper">
                                <button class="stepper-btn" onclick="App.adjustSetting('posts_per_day', -1)">&#x2212;</button>
                                <span class="stepper-value" id="setting-posts-per-day">3</span>
                                <button class="stepper-btn" onclick="App.adjustSetting('posts_per_day', 1)">+</button>
                            </div>
                        </div>
                        <div class="setting-row-numeric">
                            <span>Hours Start</span>
                            <div class="stepper">
                                <button class="stepper-btn" onclick="App.adjustSetting('posting_hours_start', -1)">&#x2212;</button>
                                <span class="stepper-value" id="setting-posting-hours-start">2pm</span>
                                <button class="stepper-btn" onclick="App.adjustSetting('posting_hours_start', 1)">+</button>
                            </div>
                        </div>
                        <div class="setting-row-numeric">
                            <span>Hours End</span>
                            <div class="stepper">
                                <button class="stepper-btn" onclick="App.adjustSetting('posting_hours_end', -1)">&#x2212;</button>
                                <span class="stepper-value" id="setting-posting-hours-end">2am</span>
                                <button class="stepper-btn" onclick="App.adjustSetting('posting_hours_end', 1)">+</button>
                            </div>
                        </div>
                        <div class="settings-divider"></div>
                        <div class="card-body-actions">
                            <button class="btn btn-action-sm" id="btn-sync-media" onclick="App.syncMedia()">Sync Media</button>
                        </div>
                        <div class="sync-result hidden" id="sync-result"></div>
                    </div>
                </div>

                <!-- System Status (expandable) -->
                <div class="home-card home-card-expandable" id="home-card-status">
                    <div class="home-card-header" onclick="App.toggleCard('status')">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x1F4E1;</span>
                            <span>System Status</span>
                        </div>
                        <div class="home-card-header-right">
                            <span class="home-card-badge" id="home-badge-status"></span>
                            <span class="home-card-chevron">&#x25B8;</span>
                        </div>
                    </div>
                    <div class="home-card-detail" id="home-detail-status"></div>
                    <div class="home-card-body" id="home-body-status">
                        <div class="card-body-loading hidden" id="status-loading">
                            <div class="spinner"></div>
                        </div>
                        <div id="status-checklist"></div>
                        <div id="status-health-checks"></div>
                    </div>
                </div>

                <!-- Schedule (expandable) -->
                <div class="home-card home-card-expandable" id="home-card-schedule">
                    <div class="home-card-header" onclick="App.toggleCard('schedule')">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x1F4C5;</span>
                            <span>Schedule</span>
                        </div>
                        <div class="home-card-header-right">
                            <span class="home-card-badge" id="home-badge-schedule"></span>
                            <span class="home-card-chevron">&#x25B8;</span>
                        </div>
                    </div>
                    <div class="home-card-detail" id="home-detail-schedule"></div>
                    <div class="home-card-body" id="home-body-schedule">
                        <div class="card-body-loading hidden" id="schedule-loading">
                            <div class="spinner"></div>
                        </div>
                        <div id="schedule-day-summary"></div>
                        <div class="card-body-actions" id="schedule-actions">
                            <button class="btn btn-action-sm" onclick="App.extendSchedule(7)">+ 7 Days</button>
                            <button class="btn btn-action-sm btn-action-danger" onclick="App.confirmRegenerate()">Regenerate</button>
                            <button class="btn btn-card-edit-inline" onclick="App.editSection('schedule')">Edit Settings</button>
                        </div>
                        <div class="confirm-dialog hidden" id="regenerate-confirm">
                            <p>Clear all pending posts and create a new schedule?</p>
                            <div class="confirm-actions">
                                <button class="btn btn-action-sm btn-action-danger" onclick="App.regenerateSchedule()">Yes, Regenerate</button>
                                <button class="btn btn-action-sm" onclick="App.cancelRegenerate()">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Queue (expandable) -->
                <div class="home-card home-card-expandable" id="home-card-queue">
                    <div class="home-card-header" onclick="App.toggleCard('queue')">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x1F4CA;</span>
                            <span>Queue</span>
                        </div>
                        <div class="home-card-header-right">
                            <span class="home-card-badge" id="home-badge-queue"></span>
                            <span class="home-card-chevron">&#x25B8;</span>
                        </div>
                    </div>
                    <div class="home-card-detail" id="home-detail-queue"></div>
                    <div class="home-card-body" id="home-body-queue">
                        <div class="card-body-loading hidden" id="queue-loading">
                            <div class="spinner"></div>
                        </div>
                        <div id="queue-items-list"></div>
                    </div>
                </div>

                <!-- Recent Activity (expandable) -->
                <div class="home-card home-card-expandable" id="home-card-history">
                    <div class="home-card-header" onclick="App.toggleCard('history')">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x1F4DC;</span>
                            <span>Recent Activity</span>
                        </div>
                        <span class="home-card-chevron">&#x25B8;</span>
                    </div>
                    <div class="home-card-detail" id="home-detail-history"></div>
                    <div class="home-card-body" id="home-body-history">
                        <div class="card-body-loading hidden" id="history-loading">
                            <div class="spinner"></div>
                        </div>
                        <div id="history-items-list"></div>
                    </div>
                </div>

                <!-- Media Library (expandable) -->
                <div class="home-card home-card-expandable" id="home-card-media">
                    <div class="home-card-header" onclick="App.toggleCard('media')">
                        <div class="home-card-title">
                            <span class="home-card-icon">&#x1F5C2;</span>
                            <span>Media Library</span>
                        </div>
                        <div class="home-card-header-right">
                            <span class="home-card-badge" id="home-badge-media"></span>
                            <span class="home-card-chevron">&#x25B8;</span>
                        </div>
                    </div>
                    <div class="home-card-detail" id="home-detail-media"></div>
                    <div class="home-card-body" id="home-body-media">
                        <div class="card-body-loading hidden" id="media-loading">
                            <div class="spinner"></div>
                        </div>
                        <div id="media-category-list"></div>
                    </div>
                </div>

                <div class="home-divider"></div>

                <button class="btn btn-secondary" onclick="App.runFullSetup()">Run Full Setup Again</button>
            </div>
        </div>

        <!-- Step 1: Welcome -->
        <div class="step" id="step-welcome">
            <div class="progress-bar"><div class="progress-fill" style="width: 14%"></div></div>
            <div class="step-content">
                <h1>Welcome to Storyline AI</h1>
                <p class="subtitle">Let's get your Instagram posting automated in a few quick steps.</p>
                <div class="step-list">
                    <div class="step-item"><span class="step-num">1</span> Connect Instagram</div>
                    <div class="step-item"><span class="step-num">2</span> Connect Google Drive</div>
                    <div class="step-item"><span class="step-num">3</span> Pick media folder</div>
                    <div class="step-item"><span class="step-num">4</span> Index your media</div>
                    <div class="step-item"><span class="step-num">5</span> Set your schedule</div>
                </div>
                <button class="btn btn-primary" onclick="App.goToStep('instagram')">Get Started</button>
            </div>
        </div>

        <!-- Step 2: Connect Instagram -->
        <div class="step hidden" id="step-instagram">
            <div class="progress-bar"><div class="progress-fill" style="width: 28%"></div></div>
            <div class="step-content">
                <h2>Connect Instagram</h2>
                <p class="subtitle">Link your Instagram Business or Creator account.</p>
                <div id="instagram-status" class="status-card">
                    <div class="status-icon status-pending">&#9679;</div>
                    <span>Not connected</span>
                </div>
                <button class="btn btn-primary" id="btn-connect-instagram" onclick="App.connectOAuth('instagram')">
                    Connect Instagram
                </button>
                <div id="instagram-polling" class="polling-indicator hidden">
                    <div class="spinner"></div>
                    <span>Waiting for authorization...</span>
                </div>
                <div class="step-nav">
                    <button class="btn btn-text" onclick="App.goToStep('gdrive')">Skip for now</button>
                </div>
                <div class="step-nav-return hidden" id="return-nav-instagram">
                    <button class="btn btn-primary" onclick="App.returnToHome()">Save &amp; Return</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Connect Google Drive -->
        <div class="step hidden" id="step-gdrive">
            <div class="progress-bar"><div class="progress-fill" style="width: 43%"></div></div>
            <div class="step-content">
                <h2>Connect Google Drive</h2>
                <p class="subtitle">Access your media files stored in Google Drive.</p>
                <div id="gdrive-status" class="status-card">
                    <div class="status-icon status-pending">&#9679;</div>
                    <span>Not connected</span>
                </div>
                <button class="btn btn-primary" id="btn-connect-gdrive" onclick="App.connectOAuth('google-drive')">
                    Connect Google Drive
                </button>
                <div id="gdrive-polling" class="polling-indicator hidden">
                    <div class="spinner"></div>
                    <span>Waiting for authorization...</span>
                </div>
                <div class="step-nav">
                    <button class="btn btn-text" onclick="App.goToStep('media-folder')">Skip for now</button>
                </div>
                <div class="step-nav-return hidden" id="return-nav-gdrive">
                    <button class="btn btn-primary" onclick="App.returnToHome()">Save &amp; Return</button>
                </div>
            </div>
        </div>

        <!-- Step 4: Media Folder -->
        <div class="step hidden" id="step-media-folder">
            <div class="progress-bar"><div class="progress-fill" style="width: 57%"></div></div>
            <div class="step-content">
                <h2>Media Folder</h2>
                <p class="subtitle">Paste the URL of the Google Drive folder with your media files.</p>
                <div class="input-group">
                    <input type="url" id="folder-url" placeholder="https://drive.google.com/drive/folders/..." />
                    <button class="btn btn-primary" onclick="App.validateFolder()">Validate</button>
                </div>
                <div id="folder-result" class="hidden">
                    <div class="result-card">
                        <div class="result-row"><strong>Files found:</strong> <span id="folder-file-count"></span></div>
                        <div class="result-row"><strong>Categories:</strong> <span id="folder-categories"></span></div>
                    </div>
                    <button class="btn btn-primary" onclick="App.goToStep('indexing')">Continue</button>
                </div>
                <div id="folder-error" class="error-text hidden"></div>
                <div class="step-nav">
                    <button class="btn btn-text" onclick="App.goToStep('schedule')">Skip for now</button>
                </div>
                <div class="step-nav-return hidden" id="return-nav-media-folder">
                    <button class="btn btn-primary" onclick="App.returnToHome()">Save &amp; Return</button>
                </div>
            </div>
        </div>

        <!-- Step 4b: Indexing -->
        <div class="step hidden" id="step-indexing">
            <div class="progress-bar"><div class="progress-fill" style="width: 71%"></div></div>
            <div class="step-content">
                <h2>Index Media</h2>
                <p class="subtitle">Import your media files into Storyline so they can be scheduled.</p>

                <div id="indexing-preview" class="result-card">
                    <div class="result-row"><strong>Files found:</strong> <span id="indexing-file-count">0</span></div>
                    <div class="result-row"><strong>Categories:</strong> <span id="indexing-categories">-</span></div>
                </div>

                <button class="btn btn-primary" id="btn-start-indexing" onclick="App.startIndexing()">
                    Index Files Now
                </button>

                <div id="indexing-progress" class="polling-indicator hidden">
                    <div class="spinner"></div>
                    <span>Indexing media files...</span>
                </div>

                <div id="indexing-result" class="hidden">
                    <div class="result-card result-success">
                        <div class="result-row"><strong>New files indexed:</strong> <span id="indexing-new-count">0</span></div>
                        <div class="result-row"><strong>Total processed:</strong> <span id="indexing-total-count">0</span></div>
                        <div id="indexing-errors" class="hidden">
                            <div class="result-row error-text"><strong>Errors:</strong> <span id="indexing-error-count">0</span></div>
                        </div>
                    </div>
                </div>

                <div id="indexing-error" class="error-text hidden"></div>

                <div class="step-nav">
                    <button class="btn btn-text" onclick="App.goToStep('schedule')">Skip, I'll index later</button>
                </div>
            </div>
        </div>

        <!-- Step 5: Schedule -->
        <div class="step hidden" id="step-schedule">
            <div class="progress-bar"><div class="progress-fill" style="width: 86%"></div></div>
            <div class="step-content">
                <h2>Posting Schedule</h2>
                <p class="subtitle">How often and when should Storyline post?</p>

                <div class="form-group">
                    <label>Posts per day</label>
                    <div class="btn-group" id="posts-per-day-group">
                        <button class="btn btn-option" data-value="1" onclick="App.selectOption('posts-per-day', 1)">1</button>
                        <button class="btn btn-option active" data-value="3" onclick="App.selectOption('posts-per-day', 3)">3</button>
                        <button class="btn btn-option" data-value="5" onclick="App.selectOption('posts-per-day', 5)">5</button>
                        <button class="btn btn-option" data-value="7" onclick="App.selectOption('posts-per-day', 7)">7</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Posting window</label>
                    <div class="btn-group" id="posting-window-group">
                        <button class="btn btn-option" data-start="9" data-end="21" onclick="App.selectWindow(9, 21)">9am - 9pm</button>
                        <button class="btn btn-option active" data-start="14" data-end="2" onclick="App.selectWindow(14, 2)">2pm - 2am</button>
                        <button class="btn btn-option" data-start="12" data-end="0" onclick="App.selectWindow(12, 0)">12pm - 12am</button>
                    </div>
                    <p class="hint">All times in UTC</p>
                </div>

                <button class="btn btn-primary" id="btn-schedule-next" onclick="App.saveSchedule()">Continue</button>
                <button class="btn btn-primary hidden" id="btn-schedule-return" onclick="App.saveScheduleAndReturn()">Save &amp; Return</button>
                <div class="step-nav">
                    <button class="btn btn-text" onclick="App.goToStep('summary')">Skip for now</button>
                </div>
            </div>
        </div>

        <!-- Step 6: Summary -->
        <div class="step hidden" id="step-summary">
            <div class="progress-bar"><div class="progress-fill" style="width: 100%"></div></div>
            <div class="step-content">
                <h2>All Set!</h2>
                <p class="subtitle">Here's your configuration summary.</p>

                <div class="summary-card">
                    <div class="summary-row">
                        <span class="summary-label">Instagram</span>
                        <span class="summary-value" id="summary-instagram">Not connected</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Google Drive</span>
                        <span class="summary-value" id="summary-gdrive">Not connected</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Media Folder</span>
                        <span class="summary-value" id="summary-media-folder">Not configured</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Media Indexed</span>
                        <span class="summary-value" id="summary-media-indexed">No</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Schedule</span>
                        <span class="summary-value" id="summary-schedule">3 posts/day</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Posting window</span>
                        <span class="summary-value" id="summary-window">2pm - 2am UTC</span>
                    </div>
                </div>

                <div class="toggle-row">
                    <label class="toggle">
                        <input type="checkbox" id="create-schedule-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Create 7-day schedule now</span>
                </div>

                <button class="btn btn-primary" onclick="App.finishSetup()">Finish Setup</button>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="hidden">
            <div class="spinner large"></div>
        </div>
    </div>

    <script src="/static/onboarding/app.js"></script>
</body>
</html>
